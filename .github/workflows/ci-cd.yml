name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  test:
    name: Run Tests & Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_mysql
          coverage: xdebug
          tools: composer:v2

      - name: Install dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Run PHPStan (Static Analysis / Linting)
        run: |
          if command -v phpstan &> /dev/null; then
            ./vendor/bin/phpstan analyse src tests --error-format=github
          else
            echo "PHPStan not installed, installing..."
            composer require --dev phpstan/phpstan
            ./vendor/bin/phpstan analyse src tests
          fi

      - name: Code Quality Check (Rector)
        run: |
          if command -v rector &> /dev/null; then
            ./vendor/bin/rector process --dry-run --no-progress-bar
          else
            echo "Rector not installed, installing..."
            composer require --dev rector/rector
            ./vendor/bin/rector process --dry-run --no-progress-bar
          fi

      - name: Code Formatting Check (PHP CS Fixer)
        run: |
          if command -v php-cs-fixer &> /dev/null; then
            ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.php --dry-run --diff --stop-on-violation --no-interaction
          else
            echo "PHP CS Fixer not installed, installing..."
            composer require --dev friendsofphp/php-cs-fixer
            ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.php --dry-run --diff --stop-on-violation --no-interaction
          fi

      - name: Run tests
        run: php vendor/bin/phpunit --testdox --coverage-text --colors=always

      - name: Check PHP syntax
        run: find src tests -name "*.php" -exec php -l {} \;

  docker-build:
    name: Build & Push Docker Image
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/php-user-api
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Show metadata tags
        run: echo "Build tags: ${{ steps.meta.outputs.tags }}"

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@v0.27.0
        with:
          scan-type: 'image'
          scan-ref: 'ghcr.io/${{ github.repository_owner }}/php-user-api:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
